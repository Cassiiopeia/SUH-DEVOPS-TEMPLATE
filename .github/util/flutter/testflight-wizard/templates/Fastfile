# ============================================
# Fastfile for iOS TestFlight Deployment
# ============================================
#
# μ΄ νμΌμ€ flutter-ios-testflight-init λ§λ²•μ‚¬μ— μν•΄ μƒμ„±λ©λ‹λ‹¤.
# GitHub Actions μ›ν¬ν”λ΅μ°μ—μ„ μ΄ νμΌμ„ μ§μ ‘ μ‚¬μ©ν•©λ‹λ‹¤.
#
# λΉλ“ νμ΄ν”„λΌμΈ:
#   1. flutter build ios --no-codesign (Flutter λΉλ“)
#   2. xcodebuild archive (Xcode μ•„μΉ΄μ΄λΈ μƒμ„±)
#   3. xcodebuild -exportArchive (IPA μƒμ„±)
#   4. fastlane upload_testflight (μ΄ νμΌμ lane μ‹¤ν–‰)
#
# ν•„μ”ν• ν™κ²½λ³€μ:
#   - APP_STORE_CONNECT_API_KEY_ID: App Store Connect API Key ID
#   - APP_STORE_CONNECT_ISSUER_ID: App Store Connect Issuer ID
#   - API_KEY_PATH: API Key νμΌ κ²½λ΅ (.p8)
#   - IPA_PATH: μ—…λ΅λ“ν•  IPA νμΌ κ²½λ΅
#   - RELEASE_NOTES: λ¦΄λ¦¬μ¦ λ…ΈνΈ (ν•κµ­μ–΄/μμ–΄ λ™μ‹ μ μ©)
#
# μ‚¬μ©λ²• (CI):
#   fastlane upload_testflight
#
# μ‚¬μ©λ²• (λ΅μ»¬):
#   bundle exec fastlane upload_testflight
#   bundle exec fastlane build_and_deploy changelog:"λ¦΄λ¦¬μ¦ λ…ΈνΈ"
#
# ============================================

default_platform(:ios)

platform :ios do
  desc "TestFlightμ— IPA μ—…λ΅λ“ (CIμ© - IPAκ°€ μ΄λ―Έ λΉλ“λ μƒνƒ)"
  lane :upload_testflight do
    UI.message("π€ TestFlight μ—…λ΅λ“ μ‹μ‘")

    # App Store Connect API Key μ„¤μ •
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: ENV["API_KEY_PATH"],
      duration: 1200,
      in_house: false
    )

    # IPA νμΌ ν™•μΈ
    ipa_path = ENV["IPA_PATH"]
    if ipa_path.nil? || ipa_path.empty?
      ipa_path = Dir.glob("build/ipa/*.ipa").first
    end

    UI.message("π“¦ IPA κ²½λ΅: #{ipa_path}")

    # λ¦΄λ¦¬μ¦ λ…ΈνΈ μ„¤μ • (Ruby 3.4+ frozen string νΈν™μ„ μ„ν•΄ .dup μ‚¬μ©)
    release_notes = (ENV["RELEASE_NOTES"] || "μƒλ΅μ΄ λΉλ“κ°€ μ—…λ΅λ“λμ—μµλ‹λ‹¤.").dup
    UI.message("π“ λ¦΄λ¦¬μ¦ λ…ΈνΈ: #{release_notes}")

    # TestFlight μ—…λ΅λ“ (upload_to_testflight = pilot)
    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
      changelog: release_notes,
      localized_build_info: {
        "ko" => { whats_new: release_notes },
        "en-US" => { whats_new: release_notes }
      },
      skip_waiting_for_build_processing: ENV["SKIP_WAITING_FOR_BUILD_PROCESSING"] == "true",
      distribute_external: false,
      notify_external_testers: false,
      uses_non_exempt_encryption: ENV["USES_NON_EXEMPT_ENCRYPTION"] == "true"
    )

    UI.success("β… TestFlight μ—…λ΅λ“ μ™„λ£!")
  end

  desc "λ΅μ»¬μ—μ„ IPA λΉλ“ λ° TestFlight μ—…λ΅λ“ (κ°λ°μ©)"
  lane :build_and_deploy do |options|
    UI.message("π—οΈ λ΅μ»¬ λΉλ“ λ° λ°°ν¬ μ‹μ‘")
    
    # App Store Connect API Key μ„¤μ •
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: ENV["API_KEY_PATH"],
      duration: 1200,
      in_house: false
    )

    # Archive μƒμ„±
    UI.message("π“¦ Archive μƒμ„± μ¤‘...")
    sh("xcodebuild -workspace Runner.xcworkspace " \
       "-scheme Runner " \
       "-archivePath build/Runner.xcarchive " \
       "-destination 'generic/platform=iOS' " \
       "archive " \
       "CODE_SIGN_STYLE=Manual " \
       "PROVISIONING_PROFILE_SPECIFIER='#{ENV['IOS_PROVISIONING_PROFILE_NAME']}' " \
       "CODE_SIGN_IDENTITY='Apple Distribution'")

    # IPA λ‚΄λ³΄λ‚΄κΈ°
    UI.message("π“¦ IPA λ‚΄λ³΄λ‚΄κΈ° μ¤‘...")
    sh("xcodebuild -exportArchive " \
       "-archivePath build/Runner.xcarchive " \
       "-exportPath build/ipa " \
       "-exportOptionsPlist ExportOptions.plist")

    # TestFlight μ—…λ΅λ“ (Ruby 3.4+ frozen string νΈν™μ„ μ„ν•΄ .dup μ‚¬μ©)
    ipa_path = Dir.glob("build/ipa/*.ipa").first
    changelog_text = (options[:changelog] || "μƒλ΅μ΄ λΉλ“κ°€ μ—…λ΅λ“λμ—μµλ‹λ‹¤.").dup
    pilot(
      api_key: api_key,
      ipa: ipa_path,
      changelog: changelog_text,
      skip_waiting_for_build_processing: ENV["SKIP_WAITING_FOR_BUILD_PROCESSING"] == "true",
      distribute_external: false,
      notify_external_testers: false,
      uses_non_exempt_encryption: false
    )

    UI.success("β… λΉλ“ λ° TestFlight μ—…λ΅λ“ μ™„λ£!")
  end
end
