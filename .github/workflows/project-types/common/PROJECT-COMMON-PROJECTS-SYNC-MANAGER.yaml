# ============================================
# PROJECT-COMMON-PROJECTS-SYNC-MANAGER.yaml
# Issue Label ‚Üí GitHub Projects Status ÎèôÍ∏∞Ìôî
#
# GitHub Projects Status ‚Üí Issue LabelÏùÄ Cloudflare WorkerÍ∞Ä Îã¥ÎãπÌï©ÎãàÎã§.
# (projects-sync-wizardÎ°ú ÏÑ§Ï†ï)
#
# Ìä∏Î¶¨Í±∞:
# - Issue Label Î≥ÄÍ≤Ω Ïãú
# - ÏàòÎèô Ïã§Ìñâ (workflow_dispatch)
# ============================================

name: üîÑ Projects Sync - Label to Status

on:
  issues:
    types: [labeled, unlabeled]

  workflow_dispatch:
    inputs:
      issue_number:
        description: 'ÎèôÍ∏∞ÌôîÌï† Issue Î≤àÌò∏'
        required: true
        type: string

concurrency:
  group: projects-sync-${{ github.event.issue.number || github.event.inputs.issue_number }}
  cancel-in-progress: true

env:
  # ÎèôÍ∏∞ÌôîÌï† Status Label Î™©Î°ù (JSON Î∞∞Ïó¥)
  # projects-sync-wizardÏóêÏÑú ÏÑ§Ï†ïÌïú Í∞íÍ≥º ÎèôÏùºÌï¥Ïïº Ìï©ÎãàÎã§
  STATUS_LABELS: '["ÏûëÏóÖÏ†Ñ", "ÏûëÏóÖÏ§ë", "Îã¥ÎãπÏûêÌôïÏù∏", "ÌîºÎìúÎ∞±", "ÏûëÏóÖÏôÑÎ£å", "Î≥¥Î•ò", "Ï∑®ÏÜå"]'

  # GitHub Projects ÏÑ§Ï†ï
  # ÏïÑÎûò Í∞íÎì§ÏùÑ Ïã§Ï†ú ÌîÑÎ°úÏ†ùÌä∏Ïóê ÎßûÍ≤å ÏàòÏ†ïÌïòÏÑ∏Ïöî
  # PROJECT_NUMBER: '1'  # Projects Î≤àÌò∏
  # ORG_NAME: 'YOUR-ORG' # Organization Ïù¥Î¶Ñ

jobs:
  sync-label-to-status:
    runs-on: ubuntu-latest
    # Ï°∞Í±¥: Status LabelÏù¥ Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ÏóêÎßå Ïã§Ìñâ
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' &&
       contains(fromJSON('["ÏûëÏóÖÏ†Ñ", "ÏûëÏóÖÏ§ë", "Îã¥ÎãπÏûêÌôïÏù∏", "ÌîºÎìúÎ∞±", "ÏûëÏóÖÏôÑÎ£å", "Î≥¥Î•ò", "Ï∑®ÏÜå"]'), github.event.label.name))

    steps:
      - name: üîç Get Issue Info
        id: issue
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "issue_number=${{ github.event.inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: üè∑Ô∏è Get Current Labels
        id: labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets._GITHUB_PAT_TOKEN }}
          script: |
            const statusLabels = JSON.parse(process.env.STATUS_LABELS);
            const issueNumber = parseInt('${{ steps.issue.outputs.issue_number }}');

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            // Status Label Ï∞æÍ∏∞
            const currentStatusLabel = issue.labels
              .map(l => typeof l === 'string' ? l : l.name)
              .find(name => statusLabels.includes(name));

            if (currentStatusLabel) {
              core.setOutput('status_label', currentStatusLabel);
              console.log(`üìå Current Status Label: ${currentStatusLabel}`);
            } else {
              core.setOutput('status_label', '');
              console.log('‚è≠Ô∏è No Status Label found');
            }

      - name: üìã Update Projects Status
        if: steps.labels.outputs.status_label != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets._GITHUB_PAT_TOKEN }}
          script: |
            const statusLabel = '${{ steps.labels.outputs.status_label }}';
            const issueNumber = parseInt('${{ steps.issue.outputs.issue_number }}');

            // ÌôòÍ≤Ω Î≥ÄÏàòÏóêÏÑú ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ (ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ Ïä§ÌÇµ)
            const projectNumber = process.env.PROJECT_NUMBER;
            const orgName = process.env.ORG_NAME;

            if (!projectNumber || !orgName) {
              console.log('‚ö†Ô∏è PROJECT_NUMBER ÎòêÎäî ORG_NAMEÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
              console.log('   ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÌôòÍ≤Ω Î≥ÄÏàòÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
              return;
            }

            console.log(`üìå Syncing Issue #${issueNumber} to Status: "${statusLabel}"`);
            console.log(`üìå Project: ${orgName}/projects/${projectNumber}`);

            // GraphQLÎ°ú Project Item ID Ï∞æÍ∏∞
            const projectItemQuery = `
              query($owner: String!, $repo: String!, $issueNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issueNumber) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          number
                        }
                      }
                    }
                  }
                }
              }
            `;

            const projectItemResult = await github.graphql(projectItemQuery, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issueNumber: issueNumber
            });

            const projectItems = projectItemResult.repository?.issue?.projectItems?.nodes || [];
            const targetItem = projectItems.find(item =>
              item.project.number === parseInt(projectNumber)
            );

            if (!targetItem) {
              console.log('‚è≠Ô∏è Issue is not linked to the target project');
              return;
            }

            console.log(`üìå Project Item ID: ${targetItem.id}`);

            // Project ÌïÑÎìú Ï†ïÎ≥¥ Ï°∞Ìöå
            const projectQuery = `
              query($org: String!, $projectNumber: Int!) {
                organization(login: $org) {
                  projectV2(number: $projectNumber) {
                    id
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;

            const projectResult = await github.graphql(projectQuery, {
              org: orgName,
              projectNumber: parseInt(projectNumber)
            });

            const statusField = projectResult.organization?.projectV2?.field;
            if (!statusField) {
              console.log('‚ùå Status field not found in project');
              return;
            }

            const targetOption = statusField.options.find(opt => opt.name === statusLabel);
            if (!targetOption) {
              console.log(`‚ùå Status option "${statusLabel}" not found in project`);
              return;
            }

            console.log(`üìå Status Option ID: ${targetOption.id}`);

            // Status ÏóÖÎç∞Ïù¥Ìä∏
            const updateMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: {
                      singleSelectOptionId: $optionId
                    }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;

            await github.graphql(updateMutation, {
              projectId: projectResult.organization.projectV2.id,
              itemId: targetItem.id,
              fieldId: statusField.id,
              optionId: targetOption.id
            });

            console.log(`‚úÖ Status updated to "${statusLabel}"`);
