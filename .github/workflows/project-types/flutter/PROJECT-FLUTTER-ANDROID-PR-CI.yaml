name: PROJECT-FLUTTER-ANDROID-PR-CI

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜ ì¶”ê°€

# PR ëŒ“ê¸€ì„ ìœ„í•œ ê¶Œí•œ ì¶”ê°€
permissions:
  contents: read
  pull-requests: write

# ============================================
# ğŸ”§ í”„ë¡œì íŠ¸ë³„ ì„¤ì • (ì•„ë˜ ê°’ë“¤ì„ ìˆ˜ì •í•˜ì„¸ìš”)
# ============================================
env:
  # Flutter/Java ë²„ì „
  FLUTTER_VERSION: "3.35.5"
  JAVA_VERSION: "17"

jobs:
  test-project-build:
    name: í”„ë¡œì íŠ¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        id: checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
        id: create-env
        run: |
          printf "%s\n" "${{ secrets.ENV }}" > .env

      - name: í‚¤ìŠ¤í† ì–´ ì„¤ì •
        id: setup-keystore
        run: |
          mkdir -p android/app/keystore
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > android/app/keystore/key.jks

          echo "storeFile=keystore/key.jks" > android/key.properties
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties

      - name: Flutter ì„¤ì •
        id: setup-flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          cache-key: flutter-${{ runner.os }}-${{ env.FLUTTER_VERSION }}

      - name: Flutter ì˜ì¡´ì„± ìºì‹±
        id: cache-flutter
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Gradle ì˜ì¡´ì„± ìºì‹±
        id: cache-gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/build.gradle', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: local.properties ìƒì„±
        id: create-local-props
        run: |
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          echo "flutter.sdk=$FLUTTER_HOME" >> android/local.properties

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        id: install-deps
        run: flutter pub get

      - name: Gradle ì„¤ì •
        id: setup-gradle
        working-directory: android
        run: chmod +x gradlew

      - name: Java ì„¤ì •
        id: setup-java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Android SDK ì„¤ì •
        id: setup-android
        uses: android-actions/setup-android@v3

      - name: ì½”ë“œ ë¶„ì„ ì‹¤í–‰
        run: |
          set -o pipefail
          flutter analyze > flutter_analyze_output.txt 2>&1 || exit 1
          echo "====== FLUTTER ANALYZE RESULT ======"
          cat flutter_analyze_output.txt
          echo "===================================="

      - name: Upload analyze log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: flutter-analyze-log
          path: flutter_analyze_output.txt

      - name: APK ë¹Œë“œ
        id: build-apk
        run: |
          # ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥
          flutter build apk --debug > flutter_build_output.txt 2>&1 || {
            echo "FLUTTER_BUILD_FAILED=true" >> $GITHUB_ENV
            echo "FLUTTER_BUILD_OUTPUT<<EOF" >> $GITHUB_ENV
            cat flutter_build_output.txt | tail -n 20 >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            exit 1
          }

      - name: ë¹Œë“œ ê²°ê³¼ í™•ì¸
        id: check-output
        run: |
          if [ ! -d "build/app/outputs/flutter-apk/" ]; then
            echo "BUILD_CHECK_FAILED=true" >> $GITHUB_ENV
            echo "BUILD_CHECK_ERROR=ë¹Œë“œ ê²°ê³¼ë¬¼ ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!" >> $GITHUB_ENV
            exit 1
          fi

          if [ ! -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            echo "BUILD_CHECK_FAILED=true" >> $GITHUB_ENV
            echo "BUILD_CHECK_ERROR=APK íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!" >> $GITHUB_ENV
            exit 1
          fi

      - name: ë¹Œë“œ ì„±ê³µ ëŒ“ê¸€ ì‘ì„±
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… í”„ë¡œì íŠ¸ ë¹Œë“œ ì„±ê³µ

              APK ë¹Œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`
            })

      - name: ë¹Œë“œ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„± - ì½”ë“œ ë¶„ì„ ì‹¤íŒ¨
        if: failure() && env.FLUTTER_ANALYZE_FAILED == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const analyzeOutput = process.env.FLUTTER_ANALYZE_OUTPUT;

            // ì—ëŸ¬ ë©”ì‹œì§€ì—ì„œ ì¤‘ìš”í•œ ë¶€ë¶„ ì¶”ì¶œ
            const errorLines = analyzeOutput.split('\n')
              .filter(line => line.includes('error') || line.includes('warning') || line.includes('issue found'))
              .join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹¤íŒ¨

            **ì‹¤íŒ¨í•œ ë‹¨ê³„:** ì½”ë“œ ë¶„ì„

            **ë¶„ì„ ê²°ê³¼:**
            \`\`\`
            ${errorLines}
            \`\`\`

            ì½”ë“œ ë‚´ ë¬¸ì œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`
            })

      - name: ë¹Œë“œ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„± - APK ë¹Œë“œ ì‹¤íŒ¨
        if: failure() && env.FLUTTER_BUILD_FAILED == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const buildOutput = process.env.FLUTTER_BUILD_OUTPUT;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹¤íŒ¨

            **ì‹¤íŒ¨í•œ ë‹¨ê³„:** APK ë¹Œë“œ

            **ë¹Œë“œ ë¡œê·¸:**
            \`\`\`
            ${buildOutput}
            \`\`\`

            ë¹Œë“œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”.`
            })

      - name: ë¹Œë“œ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„± - ê²°ê³¼ í™•ì¸ ì‹¤íŒ¨
        if: failure() && env.BUILD_CHECK_FAILED == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const error = process.env.BUILD_CHECK_ERROR;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹¤íŒ¨

            **ì‹¤íŒ¨í•œ ë‹¨ê³„:** ë¹Œë“œ ê²°ê³¼ í™•ì¸

            **ì˜¤ë¥˜:**
            ${error}

            ë¹Œë“œ í”„ë¡œì„¸ìŠ¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`
            })

      - name: ê¸°íƒ€ ë¹Œë“œ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„±
        if: failure() && env.FLUTTER_ANALYZE_FAILED != 'true' && env.FLUTTER_BUILD_FAILED != 'true' && env.BUILD_CHECK_FAILED != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // ì‹¤íŒ¨í•œ ë‹¨ê³„ ì°¾ê¸°
            let failedStep = 'ì•Œ ìˆ˜ ì—†ëŠ” ë‹¨ê³„';

            if ('${{ steps.checkout.outcome }}' === 'failure') failedStep = 'ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ';
            else if ('${{ steps.create-env.outcome }}' === 'failure') failedStep = 'í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±';
            else if ('${{ steps.setup-keystore.outcome }}' === 'failure') failedStep = 'í‚¤ìŠ¤í† ì–´ ì„¤ì •';
            else if ('${{ steps.setup-flutter.outcome }}' === 'failure') failedStep = 'Flutter ì„¤ì •';
            else if ('${{ steps.create-local-props.outcome }}' === 'failure') failedStep = 'local.properties ìƒì„±';
            else if ('${{ steps.install-deps.outcome }}' === 'failure') failedStep = 'ì˜ì¡´ì„± ì„¤ì¹˜';
            else if ('${{ steps.setup-gradle.outcome }}' === 'failure') failedStep = 'Gradle ì„¤ì •';
            else if ('${{ steps.setup-java.outcome }}' === 'failure') failedStep = 'Java ì„¤ì •';
            else if ('${{ steps.setup-android.outcome }}' === 'failure') failedStep = 'Android SDK ì„¤ì •';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹¤íŒ¨

            **ì‹¤íŒ¨í•œ ë‹¨ê³„:** ${failedStep}

            ë¹Œë“œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”.`
            })
