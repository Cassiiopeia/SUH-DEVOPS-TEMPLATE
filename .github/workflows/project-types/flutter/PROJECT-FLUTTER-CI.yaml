# ===================================================================
# Flutter CI (ë¹Œë“œ ê²€ì¦) ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” PR ìƒì„± ë˜ëŠ” main ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ
# Androidì™€ iOS ì•± ë¹Œë“œê°€ ì •ìƒì ìœ¼ë¡œ ë˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤.
#
# ì£¼ìš” íŠ¹ì§•:
# - PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ ìë™ ì‹¤í–‰
# - main ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ìë™ ì‹¤í–‰
# - Android/iOS ë¹Œë“œ ê°œë³„ í™œì„±í™”/ë¹„í™œì„±í™” ê°€ëŠ¥
# - PRì¸ ê²½ìš° ì§„í–‰ ìƒí™©ì„ ëŒ“ê¸€ë¡œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
# - ë¹Œë“œ ì‹¤íŒ¨ ì‹œ ìƒì„¸ ì—ëŸ¬ ì •ë³´ ì œê³µ
# - Androidì™€ iOS ë¹Œë“œ ë³‘ë ¬ ì‹¤í–‰ìœ¼ë¡œ ì‹œê°„ ë‹¨ì¶•
#
# ì‚¬ìš© ë°©ë²•:
# 1. í”„ë¡œì íŠ¸ì— ë§ê²Œ ìƒë‹¨ env ì„¹ì…˜ì˜ ê°’ë“¤ì„ ìˆ˜ì •í•˜ì„¸ìš”
# 2. ENABLE_ANDROID, ENABLE_IOSë¡œ ë¹Œë“œ ëŒ€ìƒ í”Œë«í¼ ì„ íƒ
# 3. ENV_FILE_PATHë¡œ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ê²½ë¡œ ì»¤ìŠ¤í„°ë§ˆì´ì§•
#
# ===================================================================
# ğŸ”§ í”„ë¡œì íŠ¸ë³„ ì„¤ì •
# ===================================================================
#
# ENABLE_ANDROID  : Android ë¹Œë“œ í™œì„±í™” ì—¬ë¶€ (true/false)
# ENABLE_IOS      : iOS ë¹Œë“œ í™œì„±í™” ì—¬ë¶€ (true/false)
# FLUTTER_VERSION : Flutter SDK ë²„ì „
# JAVA_VERSION    : Java ë²„ì „ (Android ë¹Œë“œìš©)
# XCODE_VERSION   : Xcode ë²„ì „ (iOS ë¹Œë“œìš©)
# ENV_FILE_PATH   : .env íŒŒì¼ ê²½ë¡œ (ê¸°ë³¸ê°’: ë£¨íŠ¸ì˜ .env)
#
# ===================================================================
# ğŸ“‹ í•„ìš”í•œ GitHub Secrets (ì„ íƒ)
# ===================================================================
#
# ğŸ“ í™˜ê²½ ì„¤ì •:
#   - ENV_FILE (ë˜ëŠ” ENV)  : .env íŒŒì¼ ë‚´ìš© (ì•±ì—ì„œ ì‚¬ìš©í•˜ëŠ” í™˜ê²½ë³€ìˆ˜)
#
# â€» ì°¸ê³ : CIëŠ” ë¹Œë“œ ê²€ì¦ ëª©ì ì´ë¯€ë¡œ ì„œëª…/ë°°í¬ ê´€ë ¨ Secrets ë¶ˆí•„ìš”
#         ë°°í¬ìš© ë¹Œë“œëŠ” ë³„ë„ CD ì›Œí¬í”Œë¡œìš° ì‚¬ìš©
#
# ===================================================================

name: PROJECT-Flutter-CI

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      enable_android:
        description: 'Android ë¹Œë“œ í™œì„±í™”'
        type: boolean
        default: true
      enable_ios:
        description: 'iOS ë¹Œë“œ í™œì„±í™”'
        type: boolean
        default: true

permissions:
  contents: read
  pull-requests: write

# ============================================
# ğŸ”§ í”„ë¡œì íŠ¸ë³„ ì„¤ì • (ì•„ë˜ ê°’ë“¤ì„ ìˆ˜ì •í•˜ì„¸ìš”)
# ============================================
env:
  # ğŸ¯ ë¹Œë“œ ëŒ€ìƒ í”Œë«í¼ ì„¤ì •
  ENABLE_ANDROID: "true"    # Android ë¹Œë“œ í™œì„±í™” (true/false)
  ENABLE_IOS: "true"        # iOS ë¹Œë“œ í™œì„±í™” (true/false)

  # ğŸ”§ í”„ë¡œì íŠ¸ë³„ ì„¤ì •
  FLUTTER_VERSION: "3.35.5"
  JAVA_VERSION: "17"
  XCODE_VERSION: "26.0"
  ENV_FILE_PATH: ".env"     # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ê²½ë¡œ (ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥)

concurrency:
  group: flutter-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Job 1: ì¤€ë¹„ ë‹¨ê³„
  # ============================================
  prepare:
    name: CI ì¤€ë¹„
    runs-on: ubuntu-latest

    outputs:
      comment_id: ${{ steps.comment.outputs.comment_id }}
      start_time: ${{ steps.comment.outputs.start_time }}
      branch_name: ${{ steps.info.outputs.branch_name }}
      commit_hash: ${{ steps.info.outputs.commit_hash }}
      enable_android: ${{ steps.config.outputs.enable_android }}
      enable_ios: ${{ steps.config.outputs.enable_ios }}

    steps:
      # ì„¤ì • ê°’ outputsìœ¼ë¡œ ì „ë‹¬
      # workflow_dispatch ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ env ê°’ ì‚¬ìš©
      - name: ì„¤ì • ê°’ ì „ë‹¬
        id: config
        run: |
          # workflow_dispatch ì…ë ¥ê°’ í™•ì¸
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENABLE_ANDROID="${{ github.event.inputs.enable_android }}"
            ENABLE_IOS="${{ github.event.inputs.enable_ios }}"
          else
            ENABLE_ANDROID="${{ env.ENABLE_ANDROID }}"
            ENABLE_IOS="${{ env.ENABLE_IOS }}"
          fi

          echo "enable_android=$ENABLE_ANDROID" >> $GITHUB_OUTPUT
          echo "enable_ios=$ENABLE_IOS" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ ë¹Œë“œ ì„¤ì •:"
          echo "  Android: $ENABLE_ANDROID"
          echo "  iOS: $ENABLE_IOS"
          echo "  íŠ¸ë¦¬ê±°: ${{ github.event_name }}"

      # ë¹Œë“œ ì •ë³´ ìˆ˜ì§‘
      - name: ë¹Œë“œ ì •ë³´ ìˆ˜ì§‘
        id: info
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          COMMIT_HASH=$(echo "${{ github.sha }}" | cut -c1-7)

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ ë¹Œë“œ ì •ë³´:"
          echo "  ë¸Œëœì¹˜: $BRANCH_NAME"
          echo "  ì»¤ë°‹: $COMMIT_HASH"

      # PRì¸ ê²½ìš° ì§„í–‰ ìƒí™© ëŒ“ê¸€ ìƒì„±
      - name: ì§„í–‰ ìƒí™© ëŒ“ê¸€ ìƒì„±
        id: comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const branchName = '${{ steps.info.outputs.branch_name }}';
            const commitHash = '${{ steps.info.outputs.commit_hash }}';
            const enableAndroid = '${{ steps.config.outputs.enable_android }}' === 'true';
            const enableIos = '${{ steps.config.outputs.enable_ios }}' === 'true';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            const startTime = Date.now();

            // í”Œë«í¼ ìƒíƒœ ê²°ì •
            const androidStatus = enableAndroid ? 'â³ ì§„í–‰ ì¤‘...' : 'â¸ï¸ ë¹„í™œì„±í™”';
            const iosStatus = enableIos ? 'â³ ì§„í–‰ ì¤‘...' : 'â¸ï¸ ë¹„í™œì„±í™”';

            const body = [
              '## ğŸ”¨ Flutter CI ë¹Œë“œ ì§„í–‰ ì¤‘...',
              '',
              '| í”Œë«í¼ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|--------|------|----------|',
              `| ğŸ¤– Android | ${androidStatus} | - |`,
              `| ğŸ iOS | ${iosStatus} | - |`,
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
              `| **ì»¤ë°‹** | \`${commitHash}\` |`,
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            console.log(`âœ… ì§„í–‰ ìƒí™© ëŒ“ê¸€ ìƒì„± ì™„ë£Œ: #${comment.id}`);
            core.setOutput('comment_id', comment.id);
            core.setOutput('start_time', startTime);

  # ============================================
  # Job 2: Android ë¹Œë“œ (ì¡°ê±´ë¶€, ë³‘ë ¬)
  # ============================================
  build-android:
    name: Android ë¹Œë“œ
    if: needs.prepare.outputs.enable_android == 'true'
    runs-on: ubuntu-latest
    needs: prepare

    outputs:
      status: ${{ steps.result.outputs.status }}
      duration: ${{ steps.result.outputs.duration }}

    steps:
      - name: ë¹Œë“œ ì‹œì‘ ì‹œê°„ ê¸°ë¡
        id: build_start
        uses: actions/github-script@v7
        with:
          script: |
            core.setOutput('time', Date.now().toString());

      - name: Checkout repository
        uses: actions/checkout@v4

      # .env íŒŒì¼ ìƒì„±
      - name: Create .env file
        run: |
          cat << 'EOF' > ${{ env.ENV_FILE_PATH }}
          ${{ secrets.ENV_FILE || secrets.ENV }}
          EOF
          echo "âœ… ${{ env.ENV_FILE_PATH }} file created"

      # Flutter ì„¤ì •
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Verify Flutter version
        run: |
          echo "âœ… Flutter setup completed"
          flutter --version

      # Flutter ìºì‹œ
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      # Gradle ìºì‹œ
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/build.gradle', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: |
          flutter pub get
          echo "âœ… Dependencies installed"

      # Java ì„¤ì •
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Verify Java version
        run: |
          echo "âœ… Java setup completed"
          java -version

      # Gradle ì…‹ì—…
      - name: Setup Gradle
        working-directory: android
        run: |
          chmod +x gradlew
          echo "âœ… Gradle wrapper permissions set"

      # APK ë¹Œë“œ
      - name: Build APK
        id: build
        run: |
          echo "ğŸ“¦ Flutter APK ë¹Œë“œ ì‹œì‘..."
          flutter build apk --release
          echo "âœ… APK ë¹Œë“œ ì™„ë£Œ"
          ls -la ./build/app/outputs/flutter-apk/ || true

      # ë¹Œë“œ ê²°ê³¼ ê¸°ë¡
      - name: ë¹Œë“œ ê²°ê³¼ ê¸°ë¡
        id: result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const buildStart = parseInt('${{ steps.build_start.outputs.time }}');
            const now = Date.now();
            const elapsed = now - buildStart;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const duration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;

            const status = '${{ steps.build.outcome }}' === 'success' ? 'success' : 'failure';

            core.setOutput('status', status);
            core.setOutput('duration', duration);
            console.log(`ğŸ“‹ Android ë¹Œë“œ ê²°ê³¼: ${status} (${duration})`);

  # ============================================
  # Job 3: iOS ë¹Œë“œ (ì¡°ê±´ë¶€, ë³‘ë ¬)
  # ============================================
  build-ios:
    name: iOS ë¹Œë“œ
    if: needs.prepare.outputs.enable_ios == 'true'
    runs-on: macos-15
    needs: prepare

    outputs:
      status: ${{ steps.result.outputs.status }}
      duration: ${{ steps.result.outputs.duration }}

    steps:
      - name: ë¹Œë“œ ì‹œì‘ ì‹œê°„ ê¸°ë¡
        id: build_start
        uses: actions/github-script@v7
        with:
          script: |
            core.setOutput('time', Date.now().toString());

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      # .env íŒŒì¼ ìƒì„±
      - name: Create .env file
        run: |
          cat << 'EOF' > ${{ env.ENV_FILE_PATH }}
          ${{ secrets.ENV_FILE || secrets.ENV }}
          EOF
          echo "âœ… ${{ env.ENV_FILE_PATH }} file created"

      # Flutter ì„¤ì •
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Verify Flutter version
        run: |
          echo "âœ… Flutter setup completed"
          flutter --version

      # Flutter ìºì‹œ
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: |
          flutter pub get
          echo "âœ… Dependencies installed"

      # Ruby ë° CocoaPods ì„¤ì •
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          cd ios && pod install --repo-update || pod install
          echo "âœ… CocoaPods installed"

      # iOS ë¹Œë“œ (ì„œëª… ì—†ì´)
      - name: Build iOS
        id: build
        run: |
          echo "ğŸ“¦ Flutter iOS ë¹Œë“œ ì‹œì‘..."
          flutter build ios --release --no-codesign
          echo "âœ… iOS ë¹Œë“œ ì™„ë£Œ"

      # ë¹Œë“œ ê²°ê³¼ ê¸°ë¡
      - name: ë¹Œë“œ ê²°ê³¼ ê¸°ë¡
        id: result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const buildStart = parseInt('${{ steps.build_start.outputs.time }}');
            const now = Date.now();
            const elapsed = now - buildStart;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const duration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;

            const status = '${{ steps.build.outcome }}' === 'success' ? 'success' : 'failure';

            core.setOutput('status', status);
            core.setOutput('duration', duration);
            console.log(`ğŸ“‹ iOS ë¹Œë“œ ê²°ê³¼: ${status} (${duration})`);

  # ============================================
  # Job 4: ê²°ê³¼ ë³´ê³ 
  # ============================================
  report:
    name: ê²°ê³¼ ë³´ê³ 
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: [prepare, build-android, build-ios]

    steps:
      - name: ìµœì¢… ê²°ê³¼ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = parseInt('${{ needs.prepare.outputs.comment_id }}');
            const startTime = parseInt('${{ needs.prepare.outputs.start_time }}');
            const branchName = '${{ needs.prepare.outputs.branch_name }}';
            const commitHash = '${{ needs.prepare.outputs.commit_hash }}';
            const enableAndroid = '${{ needs.prepare.outputs.enable_android }}' === 'true';
            const enableIos = '${{ needs.prepare.outputs.enable_ios }}' === 'true';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            // ë¹Œë“œ ê²°ê³¼ ìˆ˜ì§‘
            const androidStatus = '${{ needs.build-android.outputs.status }}';
            const androidDuration = '${{ needs.build-android.outputs.duration }}' || '-';
            const iosStatus = '${{ needs.build-ios.outputs.status }}';
            const iosDuration = '${{ needs.build-ios.outputs.duration }}' || '-';

            // ì „ì²´ ì†Œìš” ì‹œê°„ ê³„ì‚°
            const now = Date.now();
            const totalElapsed = now - startTime;
            const totalMin = Math.floor(totalElapsed / 60000);
            const totalSec = Math.floor((totalElapsed % 60000) / 1000);
            const totalDuration = totalMin > 0 ? `${totalMin}ë¶„ ${totalSec}ì´ˆ` : `${totalSec}ì´ˆ`;

            // ìƒíƒœ ê²°ì •
            let overallSuccess = true;
            let androidDisplay, iosDisplay;

            if (!enableAndroid) {
              androidDisplay = 'â¸ï¸ ë¹„í™œì„±í™”';
            } else if (androidStatus === 'success') {
              androidDisplay = 'âœ… ì„±ê³µ';
            } else {
              androidDisplay = 'âŒ ì‹¤íŒ¨';
              overallSuccess = false;
            }

            if (!enableIos) {
              iosDisplay = 'â¸ï¸ ë¹„í™œì„±í™”';
            } else if (iosStatus === 'success') {
              iosDisplay = 'âœ… ì„±ê³µ';
            } else {
              iosDisplay = 'âŒ ì‹¤íŒ¨';
              overallSuccess = false;
            }

            // í—¤ë” ê²°ì •
            const header = overallSuccess
              ? '## âœ… Flutter CI ë¹Œë“œ ì„±ê³µ!'
              : '## âŒ Flutter CI ë¹Œë“œ ì‹¤íŒ¨';

            // ëŒ“ê¸€ ë³¸ë¬¸ ìƒì„±
            const bodyParts = [
              header,
              '',
              '| í”Œë«í¼ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|--------|------|----------|',
              `| ğŸ¤– Android | ${androidDisplay} | ${enableAndroid ? androidDuration : '-'} |`,
              `| ğŸ iOS | ${iosDisplay} | ${enableIos ? iosDuration : '-'} |`,
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
              `| **ì»¤ë°‹** | \`${commitHash}\` |`,
              `| **ì´ ì†Œìš” ì‹œê°„** | ${totalDuration} |`,
              ''
            ];

            // ì‹¤íŒ¨ ì‹œ ì¶”ê°€ ì•ˆë‚´
            if (!overallSuccess) {
              bodyParts.push(
                '### ğŸ’¡ í™•ì¸ ì‚¬í•­',
                '1. ë¹Œë“œ ë¡œê·¸ì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”',
                '2. ì˜ì¡´ì„± ì„¤ì¹˜ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”',
                '3. Flutter ë²„ì „ í˜¸í™˜ì„±ì„ í™•ì¸í•˜ì„¸ìš”',
                ''
              );
            }

            bodyParts.push(`**[ğŸ“‹ ì›Œí¬í”Œë¡œìš° ë¡œê·¸](${runUrl})**`);

            const body = bodyParts.join('\n');

            // ëŒ“ê¸€ ì—…ë°ì´íŠ¸
            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: body
              });
              console.log(`âœ… ê²°ê³¼ ëŒ“ê¸€ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
            } else {
              console.log('âš ï¸ ëŒ“ê¸€ IDê°€ ì—†ì–´ ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.');
            }
