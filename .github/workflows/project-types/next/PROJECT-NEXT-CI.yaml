# ===================================================================
# Next.js CI (ì½”ë“œ ë¶„ì„ ë° ë¹Œë“œ ê²€ì¦)
# ===================================================================
#
# main ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¹Œë“œë¥¼ ê²€ì¦í•©ë‹ˆë‹¤.
#
# ì£¼ìš” íŠ¹ì§•:
# - npm cië¡œ ì˜ì¡´ì„± ì„¤ì¹˜
# - npm run buildë¡œ ë¹Œë“œ ê²€ì¦
# - Next.js ì¦ë¶„ ë¹Œë“œ ìºì‹± (.next/cache)
# - node_modules ìºì‹± ì§€ì›
#
# ===================================================================
# ğŸ”‘ í•„ìˆ˜ GitHub Secrets
# ===================================================================
# ENV_FILE (ì„ íƒ): .env íŒŒì¼ ë‚´ìš©
#
# â€» CIëŠ” ë¹Œë“œ ê²€ì¦ ëª©ì ì´ë¯€ë¡œ ë°°í¬ ê´€ë ¨ Secrets ë¶ˆí•„ìš”
# ===================================================================
#
# ğŸ”§ í”„ë¡œì íŠ¸ë³„ ì„¤ì • (env ì„¹ì…˜)
# ===================================================================
# PROJECT_NAME : í”„ë¡œì íŠ¸ ì´ë¦„
# NODE_VERSION : Node.js ë²„ì „ (ê¸°ë³¸: 20.15.0)
# ENV_FILE     : í™˜ê²½ë³€ìˆ˜ íŒŒì¼ëª… (ê¸°ë³¸: .env)
# ===================================================================

name: PROJECT-NEXT-CI

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  PROJECT_NAME: "project"
  NODE_VERSION: "20.15.0"
  ENV_FILE: ".env"

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  build:
    name: Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      - name: í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± (${{ env.ENV_FILE }})
        run: |
          echo -e "${{ secrets.ENV_FILE || secrets.ENV }}" > ${{ env.ENV_FILE }}
          echo "âœ… ${{ env.ENV_FILE }} íŒŒì¼ ìƒì„± ì™„ë£Œ"

      # 3. Node.js ì„¤ì •
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      # 4. npm ì˜ì¡´ì„± ìºì‹±
      - name: npm ì˜ì¡´ì„± ìºì‹±
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # 5. node_modules ìºì‹±
      - name: node_modules ìºì‹±
        id: node-modules-cache
        uses: actions/cache@v4
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      # 6. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        if: steps.node-modules-cache.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          npm ci
          echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

      # 7. Next.js ë¹Œë“œ ìºì‹± (.next/cache)
      # ì¦ë¶„ ë¹Œë“œë¥¼ ìœ„í•´ .next/cache í´ë”ë¥¼ ìºì‹±í•©ë‹ˆë‹¤
      - name: Next.js ë¹Œë“œ ìºì‹±
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      # 8. í”„ë¡œì íŠ¸ ë¹Œë“œ (SSR/SSG)
      - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
        id: build
        run: |
          echo "ğŸ”¨ Next.js ë¹Œë“œ ì‹œì‘..."
          echo "í”„ë¡œì íŠ¸: ${{ env.PROJECT_NAME }}"
          echo "Node.js: ${{ env.NODE_VERSION }}"
          echo ""

          # ë¹Œë“œ ì‹¤í–‰ ë° ë¡œê·¸ ì €ì¥
          npm run build > build_log.txt 2>&1 || {
            echo "build_failed=true" >> $GITHUB_OUTPUT
            echo "status=failed" >> $GITHUB_OUTPUT
            echo ""
            echo "âŒ ë¹Œë“œ ì‹¤íŒ¨"
            exit 0
          }

          echo "build_failed=false" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… ë¹Œë“œ ì™„ë£Œ"

          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          if [ -d ".next" ]; then
            echo ""
            echo "ğŸ“ ë¹Œë“œ ê²°ê³¼ë¬¼:"
            echo "  - .next/ í´ë” ìƒì„±ë¨"
            du -sh .next/ || true
          fi

      # 9. ë¹Œë“œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë¡œê·¸ ì¶œë ¥
      - name: ë¹Œë“œ ì—ëŸ¬ ë¡œê·¸ ì¶œë ¥
        if: steps.build.outputs.build_failed == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨ - ì—ëŸ¬ ë¡œê·¸"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          if [ -f "build_log.txt" ]; then
            tail -n 50 build_log.txt
          else
            echo "ì—ëŸ¬ ë¡œê·¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1

      # 10. ë¹Œë“œ ë¡œê·¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: ë¹Œë“œ ë¡œê·¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build_log.txt
          retention-days: 7

      # 11. ë¹Œë“œ ê²°ê³¼ ìš”ì•½
      - name: ë¹Œë“œ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ "${{ steps.build.outputs.status }}" = "success" ]; then
            echo "ğŸ‰ Next.js ë¹Œë“œ ì™„ë£Œ!"
          else
            echo "âŒ Next.js ë¹Œë“œ ì‹¤íŒ¨"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š ë¹Œë“œ ê²°ê³¼:"
          echo "  ğŸ“¦ í”„ë¡œì íŠ¸: ${{ env.PROJECT_NAME }}"
          echo "  ğŸ“Œ Node.js ë²„ì „: ${{ env.NODE_VERSION }}"
          echo "  ğŸ†™ ë¹Œë“œ ìƒíƒœ: ${{ steps.build.outputs.status }}"
          echo "  ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "  ğŸ“ ì»¤ë°‹: ${{ github.sha }}"
          echo "  ğŸ• ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
